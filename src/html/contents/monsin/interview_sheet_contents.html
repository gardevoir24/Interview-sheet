﻿﻿
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta http-equiv="Content-Script-Type" content="text/javascript" />
    <meta http-equiv="imagetoolbar" content="no" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="../../../css/common.css" type="text/css" />

    <title>中国伝統医学　問診票</title>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>
<body>
    <div id="wrap">
        <div id="header">
            <h2>問診票</h2><br />
        </div><!-- /header -->
        <div id="inner">
            <input id="back_button" type="button" value="前の質問へ戻る" class="square_btnB" onclick="onclickBackButton();">
            <input id="next_button" type="button" value="次の質問へ進む" class="square_btnN" onclick="onclickNextButton();"><br>
            <div id="Category_div"></div>
            <div id="Question_div"></div>
            <div id="Answer_div"></div>
            <div id="Progress">
                <progress id="progress_bar" value="0" max="100">0%</progress>
                <div id="progress_text"></div>
            </div>
        </div><!-- /inner -->
    </div><!-- /wrap -->

    <script type="text/javascript">
        /*ページ移動せずに内容を変更するタブ機能の作り方*/

        var count = 0;
        var datatmp;
        var max;

        (function () {
            //alert("called");
            category_target = document.getElementById("Category_div");
            question_target = document.getElementById("Question_div");
            answer_target = document.getElementById("Answer_div");
            empty_flag = false;
            disabled_char_flag = false;
            admin_url = "https://y4dda4qzjg.execute-api.ap-northeast-1.amazonaws.com/stage/resource";
            getItems();
            window.onerror = function (msg, url, linenumber) {
                alert('Error message: ' + msg + '\nURL: ' + url + '\nLine Number: ' + linenumber);
                return true;
            }
        }());

        function setForm() {
            var form_element = document.createElement("p");
            form_element.id = "tabpage" + datatmp.Items[count].LargeNum;
            //alert("form_element.id="+form_element.id);
            var id = datatmp.Items[count].id;
            var category = datatmp.Items[count].LargeSub;
            var question = datatmp.Items[count].MediumSub;
            var answer = datatmp.Items[count].SmallSub;
            var form1 = datatmp.Items[count].Form1;

            var backq = question;　//1つ前の質問

            category_target.innerHTML = "<p><strong>カテゴリ</strong>：" + category + "</p>";

            if (question != "　")
                question_target.innerHTML = "<p><strong>質問　　</strong>：" + question + "</p>";
            else
                question_target.innerHTML = "<p><strong>質問　　</strong>：以下の中から当てはまるものをすべて選択(記入)してください。</p>";

            answer_target.innerHTML = "<p><strong>回答　　</strong>："

            if (answer != "　") {

                //while (backq == question) { }

                if (question != answer) {

                    if (form1 != "◎") {

                        while (backq == question) {
                            answer = datatmp.Items[count].SmallSub;
                            question = datatmp.Items[count].MediumSub;
                            form1 = datatmp.Items[count].Form1;
                            //alert(answer);
                            if (answer == "　") break;

                            if (form1 == "◎") {
                                count--;
                                break;
                            }

                            var qForm1 = "<label for=\"" + id + "\"><input type=\"checkbox\" name=\"questionId_" + id + "\" value=\"" + answer + "\" id=\"" + id + "\"   />  " + answer + "</label>";
                            answer_target.innerHTML += qForm1 + "<br>";
                            //category_target.appendChild(form_element);
                            count++;
                            //alert(backq + "\n" + question + "\n" + qForm1);
                        }

                        answer_target.innerHTML += "</p>";

                    } else {
                        switch (true) {
                            case /^氏名$/.test(answer):
                                var qForm2 = "<p>" + answer + "（例:山田　太郎)</p><input type=\"text\" size=\"20\" name=\"questionId_" + id + "\"> <input type=\"text\" size=\"20\" name=\"questionId_" + id + "\">";
                                break;
                            case /^氏名フリガナ$/.test(answer):
                                var qForm2 = "<p>" + answer + "（例:ヤマダ　タロウ)</p><input type=\"text\" size=\"20\" name=\"questionId_" + id + "_LNK\"> <input type=\"text\" size=\"20\" name=\"questionId_" + id + "_FNK\">";
                                break;
                            case /生年月日/.test(answer):
                                var qForm2 = "<p>" + answer + "（例:2000年1月1日)</p><input type=\"text\" size=\"4\" name=\"questionId_" + id + "\">年<input type=\"text\" size=\"2\" name=\"questionId_" + id + "\">月<input type=\"text\" size=\"2\" name=\"questionId_" + id + "\">日";
                                break;
                            case /年令|才/.test(answer):
                                var qForm2 = "<p>" + answer + "（例:17歳)</p><input type=\"text\" size=\"3\" name=\"questionId_" + id + "\"> 歳";
                                break;
                            case /性別/.test(answer):
                                var qForm2 = "<p>" + answer + "<input type=\"radio\" name=\"questionId_" + id + "\" value=\"man\">男<input type=\"radio\" name=\"questionId_" + id + "\" value=\"woman\">女</p>";
                                break;
                            case /体重/.test(answer):
                                var qForm2 = "<p>" + answer + "</p><input type=\"text\" size=\"3\" name=\"questionId_" + id + "\"> kg";
                                break;
                            case /身長/.test(answer):
                                var qForm2 = "<p>" + answer + "</p><input type=\"text\" size=\"3\" name=\"questionId_" + id + "\"> cm";
                                break;
                            case /住所/.test(answer):
                                var qForm2 = "<p>郵便番号（例:123-1234）</p><input type=\"text\" size=\"10\" name=\"questionId_" + id + "\"><br><p>住所1(例:東京...)</p><input type=\"text\" size=\"50\" name=\"questionId_" + id + "\"><br><p>住所2(例:マンション名等)</p><input type=\"text\" size=\"50\" name=\"questionId_" + id + "\">";
                                break;
                            default:
                                var qForm2 = "<p>" + answer + "</p><input type=\"text\" size=\"20\" name=\"questionId_" + id + "\"><br>";
                        }
                        //id= questionId
                        //alert("qFrom2:"+qForm2);
                        answer_target.innerHTML += qForm2 + "</p>";
                    }
                } else {
                    //id= questionId
                    switch (true) {
                        case /^氏名$/.test(answer):
                            var qForm3 = "<p>" + answer + "（例:山田　太郎)</p><input type=\"text\" size=\"20\" name=\"questionId_" + id + "_LN\"> <input type=\"text\" size=\"20\" name=\"questionId_" + id + "_FN\">";
                            break;
                        case /^氏名フリガナ$/.test(answer):
                            var qForm3 = "<p>" + answer + "（例:ヤマダ　タロウ)</p><input type=\"text\" size=\"20\" name=\"questionId_" + id + "_LNK\"><input type=\"text\" size=\"20\" name=\"questionId_" + id + "_FNK\">";
                            break;
                        case /生年月日/.test(answer):
                            var qForm3 = "<p>" + answer + "（例:2000年1月1日)</p><input type=\"text\" size=\"4\" name=\"questionId_" + id + "_year\">年<input type=\"text\" size=\"2\" name=\"questionId_" + id + "_mouth\">月<input type=\"text\" size=\"2\" name=\"questionId_" + id + "_day\">日";
                            break;
                        case /年令|才/.test(answer):
                            var qForm3 = "<p>" + answer + "（例:17歳)</p><input type=\"text\" size=\"3\" name=\"questionId_" + id + "\"> 歳";
                            break;
                        case /性別/.test(answer):
                            var qForm3 = "<p>" + answer + "<input type=\"radio\" name=\"questionId_" + id + "\" value=\"man\">男<input type=\"radio\" name=\"questionId_" + id + "\" value=\"woman\">女</p>";
                            break;
                        case /体重/.test(answer):
                            var qForm3 = "<p>" + answer + "</p><input type=\"text\" size=\"3\" name=\"questionId_" + id + "\"> kg";
                            break;
                        case /身長/.test(answer):
                            var qForm3 = "<p>" + answer + "</p><input type=\"text\" size=\"3\" name=\"questionId_" + id + "\"> cm";
                            break;
                        case /住所/.test(answer):
                            var qForm3 = "<p>郵便番号（例:123-1234）</p><input type=\"text\" size=\"10\" name=\"questionId_" + id + "_posttal\"><br><p>住所1(例:東京...)</p><input type=\"text\" size=\"50\" name=\"questionId_" + id + "_Street1\"><br><p>住所2(例:マンション名等)</p><input type=\"text\" size=\"50\" name=\"questionId_" + id + "_Street2\">";
                            break;
                        default:
                            var qForm3 = "<p>" + answer + "</p><input type=\"text\" size=\"20\" name=\"questionId_" + id + "\"><br>";
                        //count++;
                    }
                    //alert("qForm3:"+qForm3);
                    answer_target.innerHTML += qForm3 + "</p>";
                }
            }
            else {
                count++;
                setForm();
            }
        }

        function updateProgress() {
            var val = Math.round((count / max * 100) * 10) / 10;
            document.getElementById("progress_bar").value = val;
            document.getElementById("progress_bar").innerText = val + "%";
            document.getElementById("progress_text").innerHTML = "現在の回答状況：" + val + "%";
        }

        //要修正
        function onclickBackButton() {
            if (count != 0) {
                count--;
                var backq = datatmp.Items[count].MediumSub;

                while (backq == datatmp.Items[count].MediumSub) {
                    if (count == 0) break;
                    count--;
                }
                if (count != 0) count++;
                setForm();
                updateProgress();
            }
            else {
                alert("これより前の質問はありません");
            }
        }

        function onclickNextButton() {
            if (count < max) {
                count++;
                setForm();
                updateProgress();
            }
            else {
                alert("これより先の質問はありません");
            }
        }

        function getItems() {
            var jsonData = {
                q: "reqQ"
            };
            $.ajax({
                type: 'POST',
                url: admin_url,
                data: JSON.stringify(jsonData),
                contentType: 'application/json',
                dataType: 'JSON',
                scriptCharset: 'utf-8',
                success: function (data) {
                    //確認用
                    var str = JSON.stringify(data);
                    jsonParsed = JSON.parse(str);
                    //alert(JSON.stringify(data));
                    data.Items.sort(function (a, b) {
                        return a.id - b.id;
                    });

                    //alert(JSON.stringify(data));
                    datatmp = data;
                    max = data.Items.length;
                    setForm();
                    updateProgress();
                },
                error: function (data) {
                    alert("データの取得に失敗しました");
                }
            });
        }

        function custom_compare(a, b) {
            return a.id - b.id;
        }

    </script>

</body>


</html>